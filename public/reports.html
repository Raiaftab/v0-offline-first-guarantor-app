<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guarantor Info Sheet Generator</title>
  <style>
    :root{
      --accent-1: #5ee7df;
      --accent-2: #b490ca;
      --glass-bg: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.12);
      --text: #eaf2f8;
      --muted: rgba(234,242,248,0.7);
      --success: #3dd875;
      --error: #ff7272;
    }

    /* Animated gradient background */
    html,body{
      height:100%;
    }
    body {
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background: linear-gradient(120deg, #061426 0%, #0b1b2b 35%, #0f2540 70%, #142a47 100%);
      overflow:auto;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* page layout */
    .container{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px 20px;
    }

    /* glass card with 3D tilt and floating */
    .card{
      width:1000px; /* Increased width */
      max-width:96%;
      padding:32px;
      border-radius:16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      box-shadow: 0 10px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px) saturate(120%);
      transform: perspective(900px) translateZ(0);
      transition: transform 400ms cubic-bezier(.2,.9,.2,1), box-shadow 300ms;
      position:relative;
      overflow:hidden;
    }

    .card:hover{
      transform: perspective(900px) translateY(-8px) rotateX(2deg) rotateY(-2deg) scale(1.01);
      box-shadow: 0 30px 60px rgba(2,6,23,0.7);
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-40% -40% auto -40%;
      height:300px;
      background: radial-gradient(1200px 300px at 10% 20%, rgba(94,231,223,0.08), transparent 10%), radial-gradient(800px 200px at 90% 80%, rgba(180,144,202,0.06), transparent 20%);
      transform:translateZ(-1px);
      pointer-events:none;
    }

    h1{
      margin:0 0 8px 0;
      font-size:28px;
      letter-spacing:0.4px;
      color:var(--text);
      text-align:left;
    }

    .subtitle{
      color:var(--muted);
      font-size:15px;
      margin-bottom:20px;
      text-align:left;
      font-weight: 300;
    }

    /* form area */
    .file-inputs-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:24px;
      margin-bottom:24px;
    }

    label{
      display:block;
      font-weight:600;
      color:var(--text); /* Brighter label */
      font-size:14px;
      margin-bottom:8px;
    }

    .file-input-group{
      display:flex;
      flex-direction:column;
    }
    .file-description{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    /* style file inputs as custom buttons */
    input[type="file"]{
      display:block;
      width:100%;
      height:48px;
      padding:8px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2);
    }

    input[type="file"]::-webkit-file-upload-button{
      visibility: hidden;
    }

    /* Dropzone visuals */
    .dropzone{
      border-radius:10px;
      padding:14px; /* Increased padding */
      display:flex;
      align-items:center;
      gap:16px; /* Increased gap */
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border: 1px dashed rgba(255,255,255,0.08); /* Brighter border for better contrast */
      transition: box-shadow 200ms, transform 200ms, border-color 160ms, background 200ms;
      cursor:pointer;
      min-height:70px; /* Ensure a minimum size */
    }
    .dropzone.dragover{
      border-color: var(--accent-1);
      box-shadow: 0 6px 18px rgba(94,231,223,0.08);
      transform: translateY(-3px);
      background: linear-gradient(180deg, rgba(94,231,223,0.03), rgba(180,144,202,0.015));
    }
    .dropzone:focus-within{
       outline: 3px solid rgba(94,231,223,0.12);
       outline-offset: 2px;
    }

    /* icon to indicate file is needed/dropped */
    .drop-icon{
      font-size:24px;
      line-height:1;
      color:var(--accent-1);
    }

    .file-info{ font-size:12px; color:var(--muted); }

    .file-wrap{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .filename{
      flex:1;
      color:var(--text); /* Brighter filename */
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:500;
    }

    /* main action button */
    .button-group{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:28px;
    }

    button{
      height:52px;
      padding:0 22px;
      font-size:16px;
      font-weight:700;
      border-radius:12px;
      border:none;
      color:#06212a;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(91,40,121,0.14), 0 2px 6px rgba(0,0,0,0.25) inset;
      transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms, opacity 220ms;
      display:flex;
      align-items:center;
      gap:8px;
    }
    button:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    button:hover:not(:disabled){
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 20px 40px rgba(67,34,99,0.18);
    }

    /* Button animation for processing/success */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .processing .spinner {
      animation: spin 1s linear infinite;
    }
    .processing, .success{
      min-width: 280px; /* Keep button size stable during animation */
    }
    .processing{
      background: var(--accent-2);
      color: var(--text);
      box-shadow: 0 8px 18px rgba(180,144,202,0.14);
    }
    .success{
      background: var(--success);
      color: #06212a;
      box-shadow: 0 8px 18px rgba(61, 216, 117, 0.25);
    }
    .error-btn {
      background: var(--error);
      color: #06212a;
      box-shadow: 0 8px 18px rgba(255, 114, 114, 0.25);
    }

    /* small helper row below */
    .footnote{
      margin-top:20px;
      text-align:left;
      font-size:13px;
      color:var(--muted);
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    /* Column Info / How-To section */
    .how-to-section{
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top:24px;
      margin-top:24px;
    }
    .how-to-section h2{
      font-size:18px;
      margin:0 0 12px 0;
      color:var(--accent-1);
    }
    .column-map-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px 32px;
      font-size:13px;
    }
    .column-item{
      display:grid;
      grid-template-columns: 110px 1fr; /* Increased width for titles */
      gap:8px;
      line-height:1.4;
    }
    .col-title{
      font-weight:600;
      color:var(--text);
    }
    .col-info{
      color:var(--muted);
    }

    /* responsive adjustments */
    @media (max-width:960px){
      .file-inputs-wrap, .column-map-grid{grid-template-columns:1fr}
      .card{padding:24px}
      .column-map-grid{gap:12px 0;}
    }

    /* subtle floating effect for the card */
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    .card[data-float]{
      animation: floaty 6.5s ease-in-out infinite;
    }

    /* Respect reduced motion preference through class or media query */
    @media (prefers-reduced-motion: reduce){
      .card[data-float], .card, button, .dropzone, .processing .spinner{ animation: none !important; transition: none !important; }
    }

    :root { --reduced-motion: 0; }
    .reduced-motion .card[data-float], .reduced-motion .card, .reduced-motion button, .reduced-motion .dropzone, .reduced-motion .processing .spinner{ animation: none !important; transition: none !important; }


    /* accessibility focus */
    input:focus, button:focus{
      outline: 3px solid rgba(94,231,223,0.12);
      outline-offset: 2px;
    }

    /* small decorative 3D strips */
    .strip{
      position:absolute;
      right:-120px;
      top:-40px;
      width:420px;
      height:420px;
      background: linear-gradient(135deg, rgba(94,231,223,0.06), rgba(180,144,202,0.04));
      transform: rotate(22deg);
      filter: blur(36px);
      pointer-events:none;
    }

    .credits{
      margin-top:16px;
      font-size:12px;
      color:var(--muted);
      text-align:right;
      width:100%;
    }

    /* helper utility classes for left alignment inside card */
    .card-header{display:flex;flex-direction:column;align-items:flex-start;margin-bottom:8px}

    /* Progress overlay (shown during processing) - used as fallback now */
    .progress-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,23,0.8), rgba(2,6,23,0.7)); /* Darker overlay */
      z-index:9999;
      pointer-events:none; /* Ensure it doesn't block clicks */
      opacity:0;
      transition: opacity 300ms;
    }
    .progress-overlay.visible{
      opacity:1;
      pointer-events:auto;
    }
    .progress-card{
      width:420px;
      max-width:92%;
      padding:18px 20px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      color:var(--text);
    }
    .progress-title{ font-weight:700; margin-bottom:8px; }
    .progress-bar{ background:rgba(255,255,255,0.04); height:12px; border-radius:8px; overflow:hidden; }
    .progress-fill{ height:100%; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); width:0%; transition: width 320ms ease; }
    .progress-text{ margin-top:8px; font-size:13px; color:var(--muted); }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-card">
      <div class="progress-title">Preparing export</div>
      <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
      <div class="progress-text">Starting...</div>
    </div>
  </div>

  <div class="container">
    <div class="card" data-float>
      <div class="strip" aria-hidden="true"></div>
      <div class="card-header">
        <h1>Guarantor Info Sheet Generator ðŸ’¾</h1>
        <div class="subtitle">Match **Active Client** data (Report 12) with **Guarantor Info** (Report 24) based on CNIC and export a consolidated list.</div>
      </div>

      <div class="file-inputs-wrap">
        <div class="file-input-group">
          <label for="sheet1">1. Guarantor Info (Report 24)</label>
          <div class="dropzone" data-target="sheet1" tabindex="0" aria-label="Drop Guarantor Info sheet here">
            <span class="drop-icon"><i class="fas fa-file-excel"></i></span>
            <input type="file" id="sheet1" accept=".xlsx,.xls">
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:2px; flex:1">
              <div class="filename" id="file1-name">No file chosen</div>
              <div class="file-info" id="file1-info">CNIC is expected in column **D** (index 3).</div>
            </div>
          </div>
          <div class="file-description">Contains guarantor and loan cycle information. Latest loan cycle will be prioritized per CNIC.</div>
        </div>

        <div class="file-input-group">
          <label for="sheet2">2. Active Client List (Report 12)</label>
          <div class="dropzone" data-target="sheet2" tabindex="0" aria-label="Drop Active Client List sheet here">
            <span class="drop-icon"><i class="fas fa-file-excel"></i></span>
            <input type="file" id="sheet2" accept=".xlsx,.xls">
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:2px; flex:1">
              <div class="filename" id="file2-name">No file chosen</div>
              <div class="file-info" id="file2-info">Client CNIC is expected in column **N** (index 13).</div>
            </div>
          </div>
          <div class="file-description">Contains client details, maturity date, and loan amount. Only clients in this list will be outputted.</div>
        </div>
      </div>

      <div class="button-group">
        <button id="merge-btn" onclick="processFiles()">
          <span class="icon"><i class="fas fa-file-download"></i></span>
          <span class="text">Generate Guarantor Excel Sheet</span>
          <span class="spinner" style="display:none"><i class="fas fa-spinner"></i></span>
        </button>
        <div class="footnote">
          <span style="color:var(--muted); font-size:13px;">Supports .xlsx and .xls. Processing is done locally in your browser.</span>
          <div class="credits">Designed By AAO</div>
        </div>
      </div>

      <div class="how-to-section">
        <h2>Column Mapping Reference (Output Columns)</h2>
        <div class="column-map-grid">
          <div class="column-item">
            <div class="col-title">Client Data:</div>
            <div class="col-info">ID (B), Name (C), Spouse (D), Product (F), CO Name (G), Cell (J), Area (P), Maturity Date (Q), Branch (S), Last Paid (U) **(From Report 12)**</div>
          </div>
          <div class="column-item">
            <div class="col-title">Guarantor Data:</div>
            <div class="col-info">Address (G), Loan Amount (I), Loan Cycle (K), Guarantor Name (O), Guarantor Cell (Q) **(From Report 24)**</div>
          </div>
        </div>
      </div>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Global constant for expected column indices (0-based)
    const COL_MAP = {
      // Report 24: Guarantor Info
      G_CNIC: 3, // D
      G_ADDRESS: 6, // G
      G_LOAN_AMOUNT: 8, // I
      G_LOAN_CYCLE: 10, // K
      G_NAME: 14, // O
      G_CELL: 16, // Q

      // Report 12: Active Clients
      A_CLIENT_ID: 1, // B
      A_NAME: 2, // C
      A_SPOUSE: 3, // D
      A_PRODUCT: 5, // F
      A_CO_NAME: 6, // G
      A_CELL_NO: 9, // J
      A_AREA: 15, // P
      A_MATURITY_DATE: 16, // Q
      A_BRANCH: 18, // S
      A_LAST_PAID: 20, // U
      A_CNIC: 13, // N (Used for matching)
    };

    /**
     * Normalizes CNIC: removes all non-numeric characters.
     * @param {string|number} value - The raw CNIC value.
     * @returns {string} The cleaned numeric CNIC string.
     */
    function normalizeCNIC(value) {
      if (value == null) return '';
      return String(value).replace(/[^0-9]/g, '').trim();
    }

    // --- Date Formatting Helper ---
    // Note: Re-using the Excel serial date logic, but making it more robust.
    const excelEpoch = new Date(1899, 11, 30); // Excel's real epoch (1899-12-30)

    function formatDDMMMYYYY(excelDateSerial) {
        if (typeof excelDateSerial !== 'number' || excelDateSerial < 1) return String(excelDateSerial || '');
        
        // Convert serial to milliseconds
        let days = excelDateSerial - 1; // 1 = 1899-12-31, so 1 day offset
        
        // Correct for Excel's 1900 leap year bug (serial 60 is Feb 29, 1900, which is invalid)
        if (excelDateSerial > 60) days -= 1; 

        const ms = days * 24 * 60 * 60 * 1000;
        const d = new Date(excelEpoch.getTime() + ms);

        if (isNaN(d.getTime())) return String(excelDateSerial);
        
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const dd = String(d.getDate()).padStart(2,'0');
        const m = months[d.getMonth()];
        const yyyy = d.getFullYear();
        return `${dd}-${m}-${yyyy}`;
    }
    // --- End Date Formatting Helper ---


    // Progress UI helpers (same as before)
    function createProgress(){
      const overlay = document.getElementById('progress-overlay');
      if(overlay) overlay.classList.add('visible');
      return overlay;
    }
    function updateProgress(percent, text){
      const o = createProgress();
      const fill = o.querySelector('.progress-fill');
      const txt = o.querySelector('.progress-text');
      const title = o.querySelector('.progress-title');
      if(fill) fill.style.width = Math.max(0,Math.min(100,percent)) + '%';
      if(txt && text !== undefined) txt.textContent = text;
      if(percent < 10) title.textContent = 'Reading files';
      else if(percent < 60) title.textContent = 'Processing data';
      else if(percent < 95) title.textContent = 'Matching & Compiling';
      else title.textContent = 'Finalizing export';
    }
    function hideProgress(){
      const o = document.getElementById('progress-overlay');
      if(o) o.classList.remove('visible');
    }

    /**
     * Updates the main button's state, text, and icon.
     * @param {'initial'|'processing'|'success'|'error'} state 
     * @param {string} text 
     * @param {string} [iconClass='fas fa-file-download'] 
     */
    function setButtonState(state = 'initial', text = 'Generate Guarantor Excel Sheet', iconClass = 'fas fa-file-download') {
      const btn = document.getElementById('merge-btn');
      const textSpan = btn.querySelector('.text');
      const iconSpan = btn.querySelector('.icon i');
      const spinner = btn.querySelector('.spinner');

      btn.className = '';
      btn.disabled = state === 'processing' || state === 'initial' && !document.getElementById('sheet1').files[0] || !document.getElementById('sheet2').files[0];
      textSpan.textContent = text;
      
      if (spinner) spinner.style.display = 'none';
      if (iconSpan) iconSpan.className = iconClass;

      if (state === 'processing') {
        btn.classList.add('processing');
        if (spinner) spinner.style.display = 'inline-block';
        if (iconSpan) iconSpan.className = 'fa-cogs'; 
      } else if (state === 'success') {
        btn.classList.add('success');
        if (iconSpan) iconSpan.className = 'fas fa-check-circle';
      } else if (state === 'error') {
        btn.classList.add('error-btn');
        if (iconSpan) iconSpan.className = 'fas fa-exclamation-triangle';
        btn.disabled = false; // Allow user to click again
      }
    }

    async function processFiles() {
      setButtonState('processing', 'Processing...');

      const file1 = document.getElementById('sheet1').files[0];
      const file2 = document.getElementById('sheet2').files[0];

      if (!file1 || !file2) {
        setButtonState('initial', 'Please upload both files', 'fas fa-arrow-up');
        document.getElementById('merge-btn').disabled = true;
        return;
      }

      // --- File Reading ---
      const p1 = new Promise((resolve, reject)=>{
        const reader1 = new FileReader();
        reader1.onload = (e1) => resolve(e1.target.result);
        reader1.onerror = () => reject('Failed to read Guarantor Info file.');
        reader1.readAsBinaryString(file1);
      });
      const p2 = new Promise((resolve, reject)=>{
        const reader2 = new FileReader();
        reader2.onload = (e2) => resolve(e2.target.result);
        reader2.onerror = () => reject('Failed to read Active Client file.');
        reader2.readAsBinaryString(file2);
      });

      updateProgress(2, 'Loading files...');
      let res1, res2;
      try{
        [res1, res2] = await Promise.all([p1,p2]);
      }catch(err){ 
        hideProgress(); 
        setButtonState('error', 'File Read Error');
        return alert(`Error: ${err}`);
      }
      
      // --- Parsing ---
      updateProgress(8, 'Parsing workbooks...');
      let data1, data2;
      try {
        const wb1 = XLSX.read(res1, { type: 'binary' });
        // Use raw:true to get raw values (e.g., date serial numbers)
        data1 = XLSX.utils.sheet_to_json(wb1.Sheets[wb1.SheetNames[0]], { header: 1, raw: true }); 
        
        const wb2 = XLSX.read(res2, { type: 'binary' });
        data2 = XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]], { header: 1, raw: true });
      } catch (err) {
        hideProgress();
        setButtonState('error', 'Parsing Failed');
        return alert('Failed to parse Excel files. Ensure they are valid .xlsx or .xls files and not corrupt.');
      }

      // --- Data Logic ---
      const filtered = {};
      const totalSteps = Math.max(1, (data1.length + data2.length) - 4); 
      let stepsDone = 0;
      const guarantorInfoStartRow = 2; // Assuming data starts on row 3

      // Pass 1: Process Report 24 (Guarantor Info) - Find latest loan cycle for each CNIC
      for (let i = guarantorInfoStartRow; i < data1.length; i++) {
        const row = data1[i];
        const cnic = normalizeCNIC(row[COL_MAP.G_CNIC]);
        const cycle = parseInt(row[COL_MAP.G_LOAN_CYCLE]) || 0;

        if (cnic.length >= 13 && row[COL_MAP.G_NAME]) { // Require full CNIC and Guarantor Name
          if (!filtered[cnic] || cycle > filtered[cnic].cycle) {
            filtered[cnic] = { index: i, cycle, rowData: row };
          }
        }
        stepsDone++;
        if(stepsDone % 500 === 0) {
          const pct = Math.round((stepsDone/totalSteps)*50);
          updateProgress(pct, `Scanning Guarantor Loans... (${i}/${data1.length-1})`);
          await new Promise(r=>setTimeout(r,0));
        }
      }

      const output = [["Client ID", "Name", "Spouse", "Product", "CO Name", "Cell No", "Area", "Maturity Date", "Branch", "Last Amount Paid", "Address", "Loan Amount", "Loan Cycle", "Guarantor Name", "Guarantor Cell"]];
      const activeClientStartRow = 2; // Assuming data starts on row 3

      // Pass 2: Iterate Report 12 (Active Clients) and match
      for (let i = activeClientStartRow; i < data2.length; i++) {
        const row2 = data2[i];
        const cnic2 = normalizeCNIC(row2[COL_MAP.A_CNIC]);
        const match = filtered[cnic2];

        if (match) {
          const row1 = match.rowData;
          
          const rawMat = row2[COL_MAP.A_MATURITY_DATE];
          const matFormatted = formatDDMMMYYYY(rawMat);
          
          output.push([
            row2[COL_MAP.A_CLIENT_ID], 
            row2[COL_MAP.A_NAME],    
            row2[COL_MAP.A_SPOUSE],    
            row2[COL_MAP.A_PRODUCT],   
            row2[COL_MAP.A_CO_NAME],   
            row2[COL_MAP.A_CELL_NO],   
            row2[COL_MAP.A_AREA],    
            matFormatted,      
            row2[COL_MAP.A_BRANCH],    
            row2[COL_MAP.A_LAST_PAID],   
            row1[COL_MAP.G_ADDRESS],   
            row1[COL_MAP.G_LOAN_AMOUNT], 
            row1[COL_MAP.G_LOAN_CYCLE],  
            row1[COL_MAP.G_NAME],    
            row1[COL_MAP.G_CELL],    
          ]);
        }
        stepsDone++;
        if(stepsDone % 500 === 0) {
          const pct = Math.round((stepsDone/totalSteps)*95);
          updateProgress(pct, `Matching Active Clients... (${i}/${data2.length-1})`);
          await new Promise(r=>setTimeout(r,0));
        }
      }

      // --- Export ---
      updateProgress(96, `Writing workbook with ${output.length - 1} matched records...`);

      try{
        const ws = XLSX.utils.aoa_to_sheet(output);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "GuarantorInfoData");
        
        // This is the function that triggers the browser download
        XLSX.writeFile(wb, "Updated Guarantor Info.xlsx"); 
        
        updateProgress(100, 'Export complete');
        setButtonState('success', 'Export Complete!');
      }catch(err){
        updateProgress(100, 'Export failed');
        console.error("Export Error:", err);
        setButtonState('error', 'Export Failed (Check Console)');
        return alert(`Download Failed! Please check if your browser blocked the file download or check the console for details.`);
      }

      // Reset UI after success/error
      setTimeout(()=> {
        hideProgress();
        if (document.getElementById('merge-btn').classList.contains('success')) {
          setTimeout(() => setButtonState('initial'), 3000); 
        }
      }, 800);
    }

    // --- UX helpers: drag & drop, filename + size display, and reduced-motion toggle (Kept for completeness) ---
    (function(){
      function humanSize(bytes){
        if(!bytes) return '';
        const units=['B','KB','MB','GB'];
        let i=0; let v=bytes;
        while(v>=1024 && i<units.length-1){v/=1024;i++;}
        return v.toFixed(v<10 && i>0?1:0)+" "+units[i];
      }

      function attachFileUI(inputId, nameElId, infoElId, defaultInfoText){
        const input = document.getElementById(inputId);
        const nameEl = document.getElementById(nameElId);
        const infoEl = document.getElementById(infoElId);
        if(!input || !nameEl) return;
        input.addEventListener('change', e=>{
          const f = e.target.files[0];
          nameEl.textContent = f ? f.name : 'No file chosen';
          if(infoEl) infoEl.textContent = f ? `${humanSize(f.size)} | ${defaultInfoText}` : defaultInfoText;
          
          const f1 = document.getElementById('sheet1').files[0];
          const f2 = document.getElementById('sheet2').files[0];
          setButtonState(f1 && f2 ? 'initial' : 'initial'); 
          document.getElementById('merge-btn').disabled = !(f1 && f2);
        });
        if (infoEl) infoEl.textContent = defaultInfoText;
      }

      attachFileUI('sheet1','file1-name','file1-info', 'CNIC expected in column D (index 3).');
      attachFileUI('sheet2','file2-name','file2-info', 'Client CNIC expected in column N (index 13).');

      const dropzones = document.querySelectorAll('.dropzone');
      dropzones.forEach(dz=>{
        const targetId = dz.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if(!input) return;
        
        ['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add('dragover'); }));
        ['dragleave','dragend'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.remove('dragover'); }));
        
        dz.addEventListener('drop', e=>{
          e.preventDefault();
          dz.classList.remove('dragover');
          const f = e.dataTransfer.files && e.dataTransfer.files[0];
          if(f && (f.name.endsWith('.xlsx') || f.name.endsWith('.xls'))){
            const dt = new DataTransfer(); dt.items.add(f); input.files = dt.files;
            input.dispatchEvent(new Event('change'));
          } else if (f) {
            alert("Invalid file type. Please upload an .xlsx or .xls file.");
          }
        });
        
        dz.addEventListener('click', (e)=>{
          if(e.target && (e.target === input || e.target.closest('input, button'))) return;
          input.click();
        });
        
        dz.addEventListener('keydown', e=>{
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if(document.activeElement === input) return;
            input.click();
          }
        });
      });

      const prefKey = 'cnic-merger-reduced-motion';
      function applyReduced(reduced){
        document.documentElement.style.setProperty('--reduced-motion', reduced ? '1' : '0');
        if(reduced) document.documentElement.classList.add('reduced-motion'); else document.documentElement.classList.remove('reduced-motion');
      }
      const saved = localStorage.getItem(prefKey);
      applyReduced(saved === '1');

      const foot = document.querySelector('.footnote');
      if(foot){
        const label = document.createElement('label');
        label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='8px'; label.style.cursor='pointer';
        label.style.marginLeft = '16px';
        label.innerHTML = `<input type="checkbox" id="rmotion" style="width:16px;height:16px; margin:0"> <span style="font-size:12px;color:var(--muted)">Reduce motion</span>`;
        const credits = document.querySelector('.credits');
        if (credits) {
          credits.style.textAlign = 'right';
          foot.appendChild(credits);
        }
        
        const cb = document.getElementById('rmotion');
        if(cb){ cb.checked = (saved === '1'); cb.addEventListener('change', ()=>{ applyReduced(cb.checked); localStorage.setItem(prefKey, cb.checked ? '1' : '0'); }); }
      }
      
      // Initial button state check
      const f1 = document.getElementById('sheet1').files[0];
      const f2 = document.getElementById('sheet2').files[0];
      setButtonState('initial', 'Upload both files to begin', 'fas fa-arrow-up');
      document.getElementById('merge-btn').disabled = !(f1 && f2);
    })();
  </script>
</body>
</html>
